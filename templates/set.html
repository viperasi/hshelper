<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>炉石助手</title>
	<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/2.3.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="http://cdn.staticfile.org/twitter-bootstrap/2.3.2/css/bootstrap-responsive.min.css">
    <link rel="stylesheet" href="{{url_for('static', filename='opentip.css')}}">

	<script src="http://cdn.staticfile.org/jquery/1.9.1/jquery.min.js"></script>
	<script src="http://cdn.staticfile.org/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
    <script src="{{url_for('static', filename='opentip-jquery.min.js')}}"></script>
	<style type="text/css">
	.fqclass{
		margin-top: -40px;
	}
	</style>
</head>
<body>
<div class="container-fluid">
	<div class="row-fluid">
		<!-- normal menu -->
		<div class="span2 hidden-phone">
			<ul class="nav nav-list">
			    <li class="nav-header">炉石助手</li>
                <li><a href="/">首页</a></li>
				<li class="nav-header">卡牌构筑</li>
                <li><a href="/set/圣骑士">圣骑士</a></li>
                <li><a href="/set/德鲁伊">德鲁伊</a></li>
                <li><a href="/set/战士">战士</a></li>
                <li><a href="/set/术士">术士</a></li>
                <li><a href="/set/法师">法师</a></li>
                <li><a href="/set/潜行者">潜行者</a></li>
                <li><a href="/set/牧师">牧师</a></li>
                <li><a href="/set/猎人">猎人</a></li>
                <li><a href="/set/萨满">萨满</a></li>
                <li class="nav-header">数据库</li>
				<li><a href="/db">数据库</a></li>
			</ul>
		</div>
  		<div class="span10">
  			<!-- phone menu -->
  			<div class="navbar visible-phone">
			  <div class="navbar-inner">
			    <div class="container">

			      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
			      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			        <span class="icon-bar"></span>
			      </a>

			      <!-- Be sure to leave the brand out there if you want it shown -->
			      <a class="brand" href="/">炉石传说数据库</a>

			      <!-- Everything you want hidden at 940px or less, place within here -->
			      <div class="nav-collapse collapse">
			        <ul class="nav nav-list">
                        <li><a href="/">首页</a></li>
				        <li class="nav-header">卡牌构筑</li>
                        <li><a href="/set/圣骑士">圣骑士</a></li>
                        <li><a href="/set/德鲁伊">德鲁伊</a></li>
                        <li><a href="/set/战士">战士</a></li>
                        <li><a href="/set/术士">术士</a></li>
                        <li><a href="/set/法师">法师</a></li>
                        <li><a href="/set/潜行者">潜行者</a></li>
                        <li><a href="/set/牧师">牧师</a></li>
                        <li><a href="/set/猎人">猎人</a></li>
                        <li><a href="/set/萨满">萨满</a></li>
                        <li class="nav-header">数据库</li>
				        <li><a href="/db">数据库</a></li>
					</ul>
			      </div>
			    </div>
			  </div>
			</div>
            <div class="span8">
                <ul class="nav nav-tabs">
                  <li class="active"><a href="#class" data-toggle="tab">{{herostr}}</a></li>
                  <li><a href="#ally" data-toggle="tab">随从</a></li>
                  <li>
                      <a href="#" onclick="share();">分享</a>
                  </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="class">
                        {% for classcard in classcards %}
                        <a href="#" style="display:inline-block;" data-id="{{classcard.id}}" data-name="{{classcard.card_name}}" data-img="{{classcard.card_img}}" class="card">
                            <pre style="width:180px;">{{classcard.card_name}}<span class='badge badge-info pull-right' id="count_{{classcard.id}}"></span></pre>
                        </a>
                        {% endfor %}
                    </div>
                    <div class="tab-pane" id="ally">
                        {% for allycard in allycards %}
                          <a href="#" style="display:inline-block;" data-id="{{allycard.id}}" data-name="{{allycard.card_name}}" data-img="{{allycard.card_img}}" class="card">
                            <pre style="width:180px;">{{allycard.card_name}}<span class='badge badge-info pull-right' id="count_{{allycard.id}}"></span></pre>
                          </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="span3">
                <p>
                    <a href="#"><h4>查看牌库情况分布<span id="allcount" class="badge badge-warning pul-right">0</span></h4></a>
                </p>
                <div id="cardlist"></div>
            </div>
  		</div>
	</div>
</div>
<div id="sharemodal" class="modal hide fade">
  <div class="modal-body">
    <p><input id="sharelink" readonly="readonly" class="input-xxlarge"/></p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
  </div>
</div>
<script>
  $(function () {
    $(document).bind('contextmenu', function(e){ return false; });
    initCards('{{cs}}');

    $(".card").each(function(){
        $(this).opentip("<img src='"+$(this).data('img')+"'/>", {style:'glass'});
    });

    $(".card").mousedown(function(e){
        if(e.which==3){
            var el = $("#cardlist").find("pre[id='"+$(this).data('id')+"']");
            var allcount = $("#allcount").text();
            if(allcount==0){
                return;
            }else{
                if(el.length>0){
                    var count = $(el[0]).find("span").text();
                    if(count>1){
                        $(el[0]).find("span").text(1);
                        $("#allcount").text(parseInt(allcount) - 1);
                        $("#count_"+$(this).data('id')).text(1);
                    }else{
                        $("#allcount").text(parseInt(allcount) - 1);
                        $(el[0]).remove();
                        $("#count_"+$(this).data('id')).text('');
                    }
                }
            }
            return;
        }
        var el = $("#cardlist").find("pre[id='"+$(this).data('id')+"']");
        var allcount = $("#allcount").text();
        if(allcount==30){
            return;
        }else{
            if(el.length>0){
                var count = $(el[0]).find("span").text();
                if(count<2){
                    $(el[0]).find("span").text(2);
                    $("#allcount").text(parseInt(allcount) + 1);
                    $("#count_"+$(this).data('id')).text(2);
                }
            }else{
                var $pre = $("<pre class='cl' data-img='"+$(this).data('img')+"' id='"+$(this).data('id')+"'>"+$(this).data('name')+"<span class='badge badge-warning pull-right'>1</span></pre>");
                $pre.opentip("<img src='"+$(this).data('img')+"'/>", {style:'glass'});
                $("#cardlist").append(
                    $pre
                );
                $("#count_"+$(this).data('id')).text(1);
                $("#allcount").text(parseInt(allcount) + 1);
            }
        }
    });

    $('#sharelink').click(function(){
        $('#sharelink').select();
    });
  });

  function share(){
    var host = location.href;
    console.log(host);
    var pres = $("#cardlist").find("pre");
    var param = "";
    pres.each(function(index,item){
        param = param + $(item).attr("id") + ":" + $(item).find("span").text() + ";";
    });
    if(host.indexOf('&')!=-1)
        host = host.substr(0, host.indexOf('&'));
    if(host.indexOf('#')==host.length-1)
        host = host.substr(0,host.length-1);
    $("#sharelink").val(host + '&' + param);
    $("#sharemodal").modal("show");
  }

  function initCards(cs){
    if(cs && cs!=''){
        var css = cs.split(';');
        var allcount = 0;
        $.each(css,function(index,item){
            var csss = item.split(':');
            if(csss[0]){
                $("#cardlist").append(
                    "<pre id='"+csss[0]+"'>"+csss[1]+"<span class='badge badge-warning pull-right'>"+csss[2]+"</span></pre>"
                );
                $("#count_"+csss[0]).text(csss[2]);
                allcount = allcount + parseInt(csss[2]);
            }
        });
        $("#allcount").text(allcount);
    }
  }
</script>
</body>
</html>